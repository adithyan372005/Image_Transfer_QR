{% extends "base.html" %}
{% block title %}Session-Based Secure Transfer - Receiver{% endblock %}

{% block content %}
<div class="header slide-in">
    <h1><i class="fas fa-download"></i> Join Secure Session</h1>
    <p>End-to-End Encrypted File Receiver</p>
    
    <div style="margin: 20px 0;">
        <div class="encryption-badge">
            <i class="fas fa-shield-alt"></i> Private Keys on Device
        </div>
        <div class="encryption-badge">
            <i class="fas fa-user-secret"></i> Zero Server Trust
        </div>
        <div class="encryption-badge">
            <i class="fas fa-trash-alt"></i> Auto-Cleanup
        </div>
    </div>
</div>

<!-- Enhanced Step Progress Indicator -->
<div class="step-indicator fade-in">
    <div class="step active" id="progress-step1">
        <div class="step-circle">1</div>
        <div class="step-label">Generate Keys</div>
    </div>
    <div class="step" id="progress-step2">
        <div class="step-circle">2</div>
        <div class="step-label">Wait for File</div>
    </div>
    <div class="step" id="progress-step3">
        <div class="step-circle">3</div>
        <div class="step-label">Decrypt</div>
    </div>
    <div class="step" id="progress-step4">
        <div class="step-circle">âœ“</div>
        <div class="step-label">Download</div>
    </div>
</div>

<div class="main-content slide-in">
                    <!-- Session Info Banner -->
                    <div class="session-banner">
                        <div class="session-info-grid">
                            <div class="session-info-item">
                                <i class="fas fa-id-card"></i>
                                <div>
                                    <span class="label">Session ID</span>
                                    <span class="value">{{ session_id }}</span>
                                </div>
                            </div>
                            <div class="session-info-item">
                                <i class="fas fa-user"></i>
                                <div>
                                    <span class="label">Sender</span>
                                    <span class="value">{{ session.sender_id }}</span>
                                </div>
                            </div>
                            <div class="session-info-item">
                                <i class="fas fa-signal"></i>
                                <div>
                                    <span class="label">Status</span>
                                    <span class="value status-active" id="sessionStatus">{{ session.status }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 1: Generate Key Pair -->
                    <div id="step1" class="step-section active-step">
                        <div class="step-header">
                            <div class="step-icon">
                                <i class="fas fa-key"></i>
                            </div>
                            <div>
                                <h3>Ready for Encryption Setup</h3>
                                <p>Generate your secure encryption keys to receive the file</p>
                            </div>
                        </div>
                        
                        <div class="step-content">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <div>
                                    <strong>Session Joined Successfully!</strong><br>
                                    You've successfully connected to the secure session
                                </div>
                            </div>
                            
                            <div class="security-guarantee">
                                <div class="guarantee-header">
                                    <i class="fas fa-shield-alt"></i>
                                    <h4>Your Security Guarantee</h4>
                                </div>
                                <div class="guarantee-list">
                                    <div class="guarantee-item">
                                        <i class="fas fa-check"></i>
                                        Private key generated on YOUR device only
                                    </div>
                                    <div class="guarantee-item">
                                        <i class="fas fa-check"></i>
                                        Server cannot access your private key
                                    </div>
                                    <div class="guarantee-item">
                                        <i class="fas fa-check"></i>
                                        True end-to-end encryption
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-center">
                                <button type="button" id="generateKeyBtn" class="btn btn-primary btn-lg">
                                    <i class="fas fa-rocket"></i> Start Encryption Process
                                </button>
                                <p class="action-hint">Keep this page open until download is complete!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Encryption Ready -->
                    <div id="step2" class="step-section" style="display: none;">
                        <div class="step-header">
                            <div class="step-icon success">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <div>
                                <h3>Encryption Setup Complete</h3>
                                <p>Keys generated! Waiting for sender to upload file</p>
                            </div>
                        </div>
                        
                        <div class="step-content">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <div>
                                    <strong>Encryption Keys Generated!</strong><br>
                                    Your private key is secure on your device and will never be shared
                                </div>
                            </div>
                            
                            <div class="key-display-container">
                                <div class="key-display-header">
                                    <i class="fas fa-key"></i>
                                    <h4>Your Public Key (Shared with Sender)</h4>
                                </div>
                                <div id="publicKeyDisplay" class="key-display"></div>
                            </div>
                            
                            <div class="waiting-container">
                                <div class="waiting-animation">
                                    <div class="pulse-circle success"></div>
                                    <div class="pulse-circle success delay-1"></div>
                                    <div class="pulse-circle success delay-2"></div>
                                </div>
                                <div class="waiting-text">
                                    <h4>ðŸ“¤ Waiting for File Upload</h4>
                                    <p>The sender is now encrypting and uploading the file using your public key.</p>
                                    <div class="crypto-indicators">
                                        <div class="crypto-indicator active">
                                            <div class="icon"><i class="fas fa-key"></i></div>
                                            ElGamal Key Pair Ready
                                        </div>
                                        <div class="crypto-indicator processing">
                                            <div class="icon"><i class="fas fa-upload"></i></div>
                                            Waiting for File Upload
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-outline-success" onclick="checkFileStatus()">
                                <i class="fas fa-sync"></i> Check for File
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Ready for Decryption -->
                    <div id="step3" class="step-section" style="display: none;">
                        <div class="step-header">
                            <div class="step-icon warning">
                                <i class="fas fa-unlock"></i>
                            </div>
                            <div>
                                <h3>File Ready for Decryption</h3>
                                <p>Encrypted file received! Ready to decrypt with your private key</p>
                            </div>
                        </div>
                        
                        <div class="step-content">
                            <div class="alert alert-info">
                                <i class="fas fa-file-download"></i>
                                <div>
                                    <strong>Encrypted File Received!</strong><br>
                                    The sender has successfully uploaded an encrypted file for you
                                </div>
                            </div>
                            
                            <div class="decryption-ready">
                                <div class="decryption-header">
                                    <i class="fas fa-shield-alt"></i>
                                    <h4>Ready for Secure Decryption</h4>
                                </div>
                                <div class="decryption-info">
                                    <div class="info-item">
                                        <i class="fas fa-key"></i>
                                        <span>Your private key will be used locally</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-lock"></i>
                                        <span>File will be decrypted on your device</span>
                                    </div>
                                    <div class="info-item">
                                        <i class="fas fa-trash-alt"></i>
                                        <span>All data deleted after download</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="action-center">
                                <button type="button" id="decryptBtn" class="btn btn-warning btn-lg">
                                    <i class="fas fa-unlock"></i> Decrypt File Now
                                </button>
                            </div>
                            
                            <div class="progress-container" id="decryptProgress">
                                <div class="progress-header">
                                    <div class="progress-title">Decrypting file with your private key...</div>
                                    <div class="progress-percentage">0%</div>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill"></div>
                                </div>
                                <div class="crypto-indicators">
                                    <div class="crypto-indicator" id="elgamalDecrypt">
                                        <div class="icon"><i class="fas fa-key"></i></div>
                                        ElGamal Key Decryption
                                    </div>
                                    <div class="crypto-indicator" id="aesDecrypt">
                                        <div class="icon"><i class="fas fa-unlock"></i></div>
                                        AES File Decryption
                                    </div>
                                    <div class="crypto-indicator" id="huffmanDecompress">
                                        <div class="icon"><i class="fas fa-expand-alt"></i></div>
                                        Huffman Decompression
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Download Ready -->
                    <div id="step4" class="step-section" style="display: none;">
                        <div class="step-header">
                            <div class="step-icon success">
                                <i class="fas fa-download"></i>
                            </div>
                            <div>
                                <h3>File Ready for Download!</h3>
                                <p>Decryption successful! Your file is ready</p>
                            </div>
                        </div>
                        
                        <div class="step-content">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i>
                                <div>
                                    <strong>File Decrypted Successfully!</strong><br>
                                    Your file has been securely decrypted using your private key
                                </div>
                            </div>
                            
                            <div id="filePreview" class="file-preview-container"></div>
                            <div id="downloadSection" class="download-container"></div>
                            
                            <div class="security-summary">
                                <div class="summary-header">
                                    <i class="fas fa-shield-check"></i>
                                    <h4>Security Summary</h4>
                                </div>
                                <div class="summary-list">
                                    <div class="summary-item">
                                        <i class="fas fa-check"></i>
                                        One-time download - file deleted after access
                                    </div>
                                    <div class="summary-item">
                                        <i class="fas fa-check"></i>
                                        Private key never left your device
                                    </div>
                                    <div class="summary-item">
                                        <i class="fas fa-check"></i>
                                        Session data automatically purged
                                    </div>
                                    <div class="summary-item">
                                        <i class="fas fa-check"></i>
                                        End-to-end encryption verified
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Display -->
                    <div id="errorAlert" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>

            <!-- Security Info -->
            <div class="card mt-4">
                <div class="card-body">
                    <h6 class="text-success"><i class="fas fa-shield-alt"></i> Your Security Guarantees</h6>
                    <ul class="list-unstyled small">
                        <li><i class="fas fa-check text-success"></i> Your private key never leaves this device</li>
                        <li><i class="fas fa-check text-success"></i> Server cannot decrypt your file</li>
                        <li><i class="fas fa-check text-success"></i> Integrity verified before decryption</li>
                        <li><i class="fas fa-check text-success"></i> One-time access with automatic cleanup</li>
                        <li><i class="fas fa-check text-success"></i> Session expires automatically</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const sessionId = '{{ session_id }}';
let privateKey = null;
let checkInterval = null;

// Step 1: Generate Key Pair
document.getElementById('generateKeyBtn').addEventListener('click', async function() {
    try {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Keys...';
        
        const response = await fetch('/generate_keypair', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Store private key locally (in real implementation, this would be in browser storage)
            privateKey = result.private_key;
            
            // Display public key info
            document.getElementById('publicKeyDisplay').innerHTML = `
                <strong>p:</strong> ${result.public_key.p.substring(0, 50)}...<br>
                <strong>g:</strong> ${result.public_key.g}<br>
                <strong>y:</strong> ${result.public_key.y.substring(0, 50)}...
            `;
            
            showStep(2);
            
            // Start checking for file upload
            checkInterval = setInterval(checkFileStatus, 3000);
        } else {
            showError(result.error);
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-key"></i> Generate Key Pair';
        }
    } catch (error) {
        showError('Key generation failed: ' + error.message);
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-key"></i> Generate Key Pair';
    }
});

// Check if file has been uploaded
async function checkFileStatus() {
    try {
        const response = await fetch(`/session_status/${sessionId}`);
        const result = await response.json();
        
        if (result.has_file) {
            clearInterval(checkInterval);
            showStep(3);
        }
    } catch (error) {
        console.error('Error checking file status:', error);
    }
}

// Step 3: Decrypt File
document.getElementById('decryptBtn').addEventListener('click', async function() {
    if (!privateKey) {
        showError('Private key not found. Please refresh and try again.');
        return;
    }
    
    try {
        this.disabled = true;
        document.getElementById('decryptProgress').style.display = 'block';
        
        const response = await fetch('/session_decrypt', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_id: sessionId,
                private_key: privateKey
            })
        });
        
        const result = await response.json();
        
        document.getElementById('decryptProgress').style.display = 'none';
        
        if (result.success) {
            // Display file preview or download link
            if (result.file_type === 'image') {
                document.getElementById('filePreview').innerHTML = `
                    <div class="text-center mb-3">
                        <img src="data:image/jpeg;base64,${result.file_data}" alt="Decrypted Image" class="img-fluid" style="max-width: 100%; max-height: 400px;">
                    </div>
                `;
            }
            
            document.getElementById('downloadSection').innerHTML = `
                <div class="text-center">
                    <a href="${result.download_url}" class="btn btn-success btn-lg" download>
                        <i class="fas fa-download"></i> Download ${result.file_name}
                    </a>
                    <p class="text-muted mt-2 small">File will be automatically deleted after download</p>
                </div>
            `;
            
            showStep(4);
        } else {
            showError(result.error);
            this.disabled = false;
        }
    } catch (error) {
        document.getElementById('decryptProgress').style.display = 'none';
        showError('Decryption failed: ' + error.message);
        this.disabled = false;
    }
});

function showStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`step${i}`).style.display = 'none';
    }
    // Show current step
    document.getElementById(`step${stepNumber}`).style.display = 'block';
}

function showError(message) {
    const errorAlert = document.getElementById('errorAlert');
    errorAlert.textContent = message;
    errorAlert.style.display = 'block';
    setTimeout(() => {
        errorAlert.style.display = 'none';
    }, 5000);
}

// Enhanced UI functions for receiver
function showStep(stepNumber) {
    // Hide all steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        if (step) {
            step.style.display = 'none';
            step.classList.remove('active-step');
        }
    }
    
    // Show current step with animation
    const currentStep = document.getElementById(`step${stepNumber}`);
    if (currentStep) {
        currentStep.style.display = 'block';
        currentStep.classList.add('active-step', 'slide-in');
    }
    
    // Update progress indicator
    updateStepIndicator(stepNumber - 1);
}

function updateStepIndicator(activeStep) {
    for (let i = 1; i <= 4; i++) {
        const progressStep = document.getElementById(`progress-step${i}`);
        if (progressStep) {
            progressStep.classList.remove('active', 'completed');
            if (i <= activeStep) {
                progressStep.classList.add('completed');
            } else if (i === activeStep + 1) {
                progressStep.classList.add('active');
            }
        }
    }
}

// Simulate decryption progress
function simulateDecryptionProgress() {
    const indicators = ['elgamalDecrypt', 'aesDecrypt', 'huffmanDecompress'];
    let currentStep = 0;
    
    function activateStep() {
        if (currentStep < indicators.length) {
            updateCryptoIndicator(`#${indicators[currentStep]}`, 'processing');
            setTimeout(() => {
                updateCryptoIndicator(`#${indicators[currentStep]}`, 'completed');
                currentStep++;
                if (currentStep < indicators.length) {
                    setTimeout(activateStep, 500);
                }
            }, 1000);
        }
    }
    
    activateStep();
}
</script>

<style>
/* Session Banner */
.session-banner {
    background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(56, 161, 105, 0.1) 100%);
    border: 2px solid rgba(72, 187, 120, 0.2);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
}

.session-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.session-info-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    border: 1px solid rgba(72, 187, 120, 0.1);
}

.session-info-item i {
    font-size: 1.5em;
    color: var(--success-color);
    width: 30px;
    text-align: center;
}

.session-info-item .label {
    font-size: 0.9em;
    color: var(--text-secondary);
    display: block;
}

.session-info-item .value {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1.05em;
    display: block;
}

.session-info-item .value.status-active {
    color: var(--success-color);
    text-transform: uppercase;
    font-size: 0.95em;
}

/* Enhanced Step Sections - same as sender */
.step-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
    border-radius: var(--border-radius);
    padding: 30px;
    margin: 25px 0;
    border: 2px solid transparent;
    box-shadow: var(--shadow-light);
    transition: var(--transition);
    opacity: 0.7;
    transform: translateY(10px);
}

.step-section.active-step {
    border-color: var(--success-color);
    box-shadow: var(--shadow-heavy);
    opacity: 1;
    transform: translateY(0);
}

.step-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 2px solid #e2e8f0;
}

.step-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8em;
    background: var(--primary-gradient);
    color: white;
    box-shadow: var(--shadow-medium);
    flex-shrink: 0;
}

.step-icon.success {
    background: var(--secondary-gradient);
}

.step-icon.warning {
    background: var(--warning-gradient);
}

.step-header h3 {
    margin: 0 0 8px 0;
    color: var(--text-primary);
    font-size: 1.5em;
    font-weight: 600;
}

.step-header p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 1.05em;
}

/* Security Guarantee */
.security-guarantee {
    background: rgba(72, 187, 120, 0.05);
    border: 2px solid rgba(72, 187, 120, 0.2);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
}

.guarantee-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.guarantee-header i {
    font-size: 1.5em;
    color: var(--success-color);
}

.guarantee-header h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.2em;
}

.guarantee-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.guarantee-item {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
    font-weight: 500;
}

.guarantee-item i {
    color: var(--success-color);
    font-size: 1.1em;
    width: 20px;
}

/* Key Display */
.key-display-container {
    background: rgba(102, 126, 234, 0.05);
    border: 2px solid rgba(102, 126, 234, 0.1);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
}

.key-display-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.key-display-header i {
    font-size: 1.3em;
    color: var(--primary-color);
}

.key-display-header h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.1em;
}

.key-display {
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(102, 126, 234, 0.2);
    border-radius: 8px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.85em;
    color: var(--text-secondary);
    word-break: break-all;
    line-height: 1.4;
    max-height: 150px;
    overflow-y: auto;
}

/* Decryption Ready */
.decryption-ready {
    background: rgba(237, 137, 54, 0.05);
    border: 2px solid rgba(237, 137, 54, 0.2);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
}

.decryption-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.decryption-header i {
    font-size: 1.5em;
    color: #c05621;
}

.decryption-header h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.2em;
}

.decryption-info {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
    font-weight: 500;
}

.info-item i {
    color: #c05621;
    font-size: 1.1em;
    width: 20px;
}

/* Action Center */
.action-center {
    text-align: center;
    margin: 30px 0;
}

.action-hint {
    margin-top: 15px;
    color: var(--text-secondary);
    font-style: italic;
    font-size: 0.95em;
}

/* File Preview Container */
.file-preview-container {
    background: rgba(248, 250, 252, 0.8);
    border: 2px solid #e2e8f0;
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
    text-align: center;
}

.download-container {
    background: rgba(72, 187, 120, 0.05);
    border: 2px solid rgba(72, 187, 120, 0.2);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
    text-align: center;
}

/* Security Summary */
.security-summary {
    background: linear-gradient(135deg, rgba(72, 187, 120, 0.05) 0%, rgba(56, 161, 105, 0.05) 100%);
    border: 2px solid rgba(72, 187, 120, 0.2);
    border-radius: var(--border-radius);
    padding: 25px;
    margin: 25px 0;
}

.summary-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.summary-header i {
    font-size: 1.5em;
    color: var(--success-color);
}

.summary-header h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 1.2em;
}

.summary-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.summary-item {
    display: flex;
    align-items: center;
    gap: 12px;
    color: var(--text-primary);
    font-weight: 500;
}

.summary-item i {
    color: var(--success-color);
    font-size: 1.1em;
    width: 20px;
}

/* Pulse animations for success */
.pulse-circle.success {
    border-color: var(--success-color);
}

/* Responsive Design */
@media (max-width: 768px) {
    .session-info-grid {
        grid-template-columns: 1fr;
    }
    
    .session-info-item {
        padding: 12px;
    }
    
    .step-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .guarantee-list,
    .decryption-info,
    .summary-list {
        gap: 8px;
    }
    
    .key-display {
        font-size: 0.75em;
        max-height: 120px;
    }
    
    .action-center {
        margin: 20px 0;
    }
}

@media (max-width: 480px) {
    .session-banner {
        padding: 15px;
    }
    
    .step-section {
        padding: 20px;
    }
    
    .security-guarantee,
    .key-display-container,
    .decryption-ready,
    .security-summary {
        padding: 15px;
    }
    
    .guarantee-header h4,
    .decryption-header h4,
    .summary-header h4 {
        font-size: 1.05em;
    }
}
</style>

{% endblock %}