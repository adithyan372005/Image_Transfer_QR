{% extends "base.html" %}

{% block title %}Send File - Secure Transfer{% endblock %}

{% block content %}
<div style="margin-bottom: 20px;">
    <a href="/" style="color: var(--primary-color); text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-weight: 500; transition: var(--transition);">
        <i class="fas fa-arrow-left"></i> Back to Home
    </a>
</div>

<div class="header slide-in">
    <h1><i class="fas fa-shield-alt"></i> Send Secure File</h1>
    <p>Advanced cryptographic protection for your documents</p>
</div>

<!-- Encryption Process Steps -->
<div class="security-features slide-in" style="margin-bottom: 30px;">
    <h3>Encryption Process</h3>
    <div class="step-indicator">
        <div class="step" id="step-upload">
            <div class="step-circle">1</div>
            <div class="step-label">Upload</div>
        </div>
        <div class="step" id="step-compress">
            <div class="step-circle">2</div>
            <div class="step-label">Compress</div>
        </div>
        <div class="step" id="step-encrypt">
            <div class="step-circle">3</div>
            <div class="step-label">Encrypt</div>
        </div>
        <div class="step" id="step-generate">
            <div class="step-circle">4</div>
            <div class="step-label">Generate QR</div>
        </div>
    </div>
</div>

<!-- Live Crypto Indicators -->
<div class="crypto-indicators" style="display: none; margin: 20px 0;">
    <div class="crypto-indicator" id="indicator-huffman">
        <i class="fas fa-compress-alt icon"></i> Huffman Compression
    </div>
    <div class="crypto-indicator" id="indicator-aes">
        <i class="fas fa-lock icon"></i> AES-256 Encryption
    </div>
    <div class="crypto-indicator" id="indicator-elgamal">
        <i class="fas fa-key icon"></i> ElGamal Key Exchange
    </div>
    <div class="crypto-indicator" id="indicator-hash">
        <i class="fas fa-fingerprint icon"></i> SHA-256 Hashing
    </div>
    <div class="crypto-indicator" id="indicator-qr">
        <i class="fas fa-qrcode icon"></i> QR Code Generation
    </div>
</div>

<!-- Enhanced Progress Container -->
<div class="progress-container" id="progressContainer">
    <div class="progress-header">
        <span class="progress-title" id="progressTitle">Initializing...</span>
        <span class="progress-percentage" id="progressPercentage">0%</span>
    </div>
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>
    <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 8px;" id="progressDetail">
        Preparing secure encryption pipeline...
    </div>
</div>

    <form id="uploadForm" enctype="multipart/form-data">
        <div class="form-group">
            <label for="fileInput">Select File (Image or PDF)</label>
            <input type="file" id="fileInput" name="file" class="form-control" 
                   accept=".jpg,.jpeg,.png,.gif,.pdf" required>
            <small style="color: #718096; margin-top: 5px; display: block;">
                Supported: JPG, PNG, GIF, PDF (Max: 10MB)
            </small>
        </div>

        <div class="form-group">
            <label for="intendedReceiverName">Intended Receiver Name</label>
            <input type="text" id="intendedReceiverName" name="intended_receiver_name" class="form-control" 
                   placeholder="Enter the receiver's name" maxlength="50" required>
            <small style="color: #718096; margin-top: 5px; display: block;">
                Required: The receiver must enter this exact name to access the file
            </small>
        </div>

        <div class="form-group">
            <label for="expirySelect">Link Expiry Time</label>
            <select id="expirySelect" name="expiry" class="form-control">
                <option value="2">2 minutes</option>
                <option value="5" selected>5 minutes</option>
                <option value="10">10 minutes</option>
            </select>
        </div>

        <button type="submit" class="btn" id="submitBtn">
            <i class="fas fa-shield-alt"></i> Start Secure Encryption
        </button>
    </form>

    <!-- Results will be shown here -->
    <div id="results" style="display: none;">
        <div class="alert alert-success">
            <strong>File encrypted successfully!</strong> Share the QR code and PIN with the receiver.
        </div>

        <div class="qr-container">
            <h3 style="margin-bottom: 15px;">üì± QR Code</h3>
            <div id="qrCode"></div>
            <p style="margin-top: 10px; color: #718096; font-size: 0.9em;">
                Scan with Google Lens or any QR scanner
            </p>
        </div>

        <div style="margin: 20px 0;">
            <h3>üîë Access PIN</h3>
            <div class="pin-display" id="pinDisplay"></div>
            <p style="color: #718096; font-size: 0.9em;">
                Share this PIN with the receiver (required for decryption)
            </p>
        </div>

        <!-- Compression Statistics -->
        <div id="compressionStats" style="background: #e6fffa; padding: 15px; border-radius: 8px; margin: 20px 0; display: none;">
            <h4 style="color: #234e52; margin-bottom: 10px;">üìä Compression Statistics</h4>
            <div style="text-align: left; color: #234e52; font-size: 0.9em;">
                <p><strong>Original Size:</strong> <span id="originalSize"></span></p>
                <p><strong>Compressed Size:</strong> <span id="compressedSize"></span></p>
                <p><strong>Compression Ratio:</strong> <span id="compressionRatio"></span></p>
                <p style="font-size: 0.8em; color: #2d3748; margin-top: 10px;">
                    üîí Your file was compressed before encryption for optimal security and transfer speed.
                </p>
            </div>
        </div>

        <div style="background: #fefcbf; padding: 15px; border-radius: 8px; margin: 20px 0;">
            <h4 style="color: #744210; margin-bottom: 10px;">‚ö†Ô∏è Important</h4>
            <ul style="text-align: left; color: #744210; font-size: 0.9em;">
                <li>Link expires: <span id="expiryTime"></span></li>
                <li>Maximum 3 PIN attempts allowed</li>
                <li>File will be deleted after successful access</li>
                <li>Keep this page open until receiver accesses the file</li>
            </ul>
        </div>

        <!-- Access Status -->
        <div id="statusSection" style="background: #f0fff4; padding: 15px; border-radius: 8px; margin: 20px 0; display: none;">
            <h4 style="color: #22543d; margin-bottom: 10px;">üìä Access Status</h4>
            <div id="statusInfo" style="color: #22543d; font-size: 0.9em;">
                <!-- Status information will be displayed here -->
            </div>
            <button onclick="checkStatus()" class="btn btn-secondary" style="margin-top: 10px; font-size: 0.9em;">
                üîÑ Refresh Status
            </button>
        </div>

        <button onclick="sendAnother()" class="btn btn-secondary">
            üì§ Send Another File
        </button>
    </div>
</div>

<script>
// Add debugging console logs
console.log('Send page JavaScript loaded');

// Test button click immediately
setTimeout(() => {
    const testBtn = document.getElementById('submitBtn');
    if (testBtn) {
        console.log('Button found, adding test click listener');
        testBtn.addEventListener('click', () => {
            console.log('BUTTON CLICKED! This should trigger form submission.');
        });
    }
}, 1000);

// Check if form exists
const uploadForm = document.getElementById('uploadForm');
console.log('Upload form found:', uploadForm);

if (uploadForm) {
    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submission triggered - POST request should start now');
    
    clearAlerts();
    const fileInput = document.getElementById('fileInput');
    const expirySelect = document.getElementById('expirySelect');
    const intendedReceiverName = document.getElementById('intendedReceiverName');
    
    if (!fileInput.files[0]) {
        showAlert('Please select a file to upload.');
        return;
    }
    
    if (!intendedReceiverName.value.trim()) {
        showAlert('Please enter the intended receiver name.');
        return;
    }
    
    const file = fileInput.files[0];
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        showAlert('File size must be less than 10MB.');
        return;
    }
    
    // Validate file type
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'application/pdf'];
    if (!allowedTypes.includes(file.type)) {
        showAlert('Please select a valid image (JPG, PNG, GIF) or PDF file.');
        return;
    }
    
    // Start enhanced encryption process
    startEncryptionProcess();
    document.querySelector('form').style.display = 'none';
    
    try {
        console.log('Starting file upload process...');
        const formData = new FormData();
        formData.append('file', file);
        formData.append('expiry', expirySelect.value);
        formData.append('intended_receiver_name', intendedReceiverName.value.trim());
        
        console.log('FormData prepared, sending POST to /upload');
        console.log('File:', file.name, 'Size:', file.size);
        console.log('Expiry:', expirySelect.value);
        console.log('Receiver:', intendedReceiverName.value.trim());
        
        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });
        
        console.log('Response received:', response.status, response.statusText);
        const result = await response.json();
        console.log('Response JSON:', result);
        
        if (result.success) {
            // Store transaction ID globally for status checking
            window.currentTransactionId = result.transaction_id;
            
            // Show results
            document.getElementById('qrCode').innerHTML = `<img src="${result.qr_code}" alt="QR Code" style="max-width: 300px; height: auto;">`;
            document.getElementById('pinDisplay').textContent = result.pin;
            document.getElementById('expiryTime').textContent = result.expiry_time;
            
            // Show compression statistics
            document.getElementById('originalSize').textContent = formatFileSize(result.original_size);
            document.getElementById('compressedSize').textContent = formatFileSize(result.compressed_size);
            document.getElementById('compressionRatio').textContent = `${result.compression_ratio.toFixed(2)}%`;
            document.getElementById('compressionStats').style.display = 'block';
            
            // Show status section and start checking
            document.getElementById('statusSection').style.display = 'block';
            checkStatus();
            
            // Auto-check status every 10 seconds
            if (window.statusInterval) clearInterval(window.statusInterval);
            window.statusInterval = setInterval(checkStatus, 10000);
            
            document.getElementById('results').style.display = 'block';
            
            // Show success message
            showAlert('File encrypted and QR code generated successfully!', 'success');
        } else {
            showAlert(result.error || 'Upload failed. Please try again.');
            document.querySelector('form').style.display = 'block';
        }
    } catch (error) {
        console.error('Upload error:', error);
        showAlert('Network error. Please check your connection and try again.');
        document.querySelector('form').style.display = 'block';
    }
    
    completeEncryptionProcess();
    });
} else {
    console.error('Upload form not found! Check HTML structure.');
}

// Add click event listener to button as backup
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, setting up event listeners');
    
    const submitBtn = document.getElementById('submitBtn');
    console.log('Submit button found:', submitBtn);
    
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('Button clicked directly!');
            e.preventDefault();
            
            // Trigger form submission manually
            const form = document.getElementById('uploadForm');
            if (form) {
                console.log('Manually triggering form submission');
                const event = new Event('submit', { cancelable: true });
                form.dispatchEvent(event);
            }
        });
    }
});

// Enhanced encryption process visualization
function startEncryptionProcess() {
    // Show progress indicators
    document.querySelector('.crypto-indicators').style.display = 'block';
    document.getElementById('progressContainer').classList.add('show');
    
    // Update step indicator
    updateStepIndicator(0);
    
    // Simulate real-time encryption steps
    setTimeout(() => {
        updateProgress(10, 'Reading file...');
        updateCryptoIndicator('#indicator-huffman', 'processing');
        updateProgressDetail('Analyzing file structure and preparing compression...');
    }, 300);
    
    setTimeout(() => {
        updateProgress(25, 'Huffman Compression...');
        updateStepIndicator(1);
        updateProgressDetail('Applying Huffman coding for optimal compression...');
    }, 800);
    
    setTimeout(() => {
        updateProgress(40, 'Generating Keys...');
        updateCryptoIndicator('#indicator-huffman', 'completed');
        updateCryptoIndicator('#indicator-elgamal', 'processing');
        updateProgressDetail('Creating ElGamal key pair for secure exchange...');
    }, 1300);
    
    setTimeout(() => {
        updateProgress(60, 'AES Encryption...');
        updateStepIndicator(2);
        updateCryptoIndicator('#indicator-elgamal', 'completed');
        updateCryptoIndicator('#indicator-aes', 'processing');
        updateProgressDetail('Encrypting with AES-256 military-grade security...');
    }, 1800);
    
    setTimeout(() => {
        updateProgress(80, 'Hash Generation...');
        updateCryptoIndicator('#indicator-aes', 'completed');
        updateCryptoIndicator('#indicator-hash', 'processing');
        updateProgressDetail('Generating SHA-256 integrity hash...');
    }, 2300);
    
    setTimeout(() => {
        updateProgress(95, 'Creating QR Code...');
        updateStepIndicator(3);
        updateCryptoIndicator('#indicator-hash', 'completed');
        updateCryptoIndicator('#indicator-qr', 'processing');
        updateProgressDetail('Generating secure QR code for sharing...');
    }, 2800);
}

function completeEncryptionProcess() {
    updateProgress(100, 'Encryption Complete!');
    updateStepIndicator(4);
    updateCryptoIndicator('#indicator-qr', 'completed');
    updateProgressDetail('File successfully encrypted and ready for secure transfer');
    
    // Mark all steps as completed
    document.querySelectorAll('.step').forEach(step => step.classList.add('completed'));
    
    // Hide progress after a moment
    setTimeout(() => {
        document.getElementById('progressContainer').classList.remove('show');
    }, 2000);
}

function updateProgressDetail(detail) {
    document.getElementById('progressDetail').textContent = detail;
}

// File input change handler to show file info
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const fileInfo = document.createElement('div');
        fileInfo.style.marginTop = '10px';
        fileInfo.style.color = '#718096';
        fileInfo.style.fontSize = '0.9em';
        fileInfo.innerHTML = `
            <strong>Selected:</strong> ${file.name} (${formatFileSize(file.size)})
        `;
        
        // Remove previous file info
        const existing = this.parentNode.querySelector('.file-info');
        if (existing) existing.remove();
        
        fileInfo.className = 'file-info';
        this.parentNode.appendChild(fileInfo);
    }
});

async function checkStatus() {
    if (!window.currentTransactionId) return;
    
    try {
        const response = await fetch(`/status/${window.currentTransactionId}`);
        const result = await response.json();
        
        if (result.error) {
            document.getElementById('statusInfo').innerHTML = `
                <p><strong>Status:</strong> ‚ùå ${result.error}</p>
            `;
            // Stop checking if transaction not found
            if (window.statusInterval) clearInterval(window.statusInterval);
            return;
        }
        
        const statusInfo = document.getElementById('statusInfo');
        let statusHtml = `<p><strong>Status:</strong> `;
        
        switch(result.status) {
            case 'ACTIVE':
                statusHtml += `üü° Waiting for receiver</p>`;
                statusHtml += `<p><strong>Created:</strong> ${new Date(result.created_at).toLocaleString()}</p>`;
                statusHtml += `<p><strong>Expires:</strong> ${new Date(result.expiry_time).toLocaleString()}</p>`;
                break;
                
            case 'ACCESSED':
                statusHtml += `üü† File accessed, waiting for download</p>`;
                if (result.receiver_name) {
                    statusHtml += `<p><strong>Accessed by:</strong> ${result.receiver_name}</p>`;
                }
                statusHtml += `<p><strong>Access time:</strong> ${new Date(result.access_time).toLocaleString()}</p>`;
                break;
                
            case 'DOWNLOADED':
                statusHtml += `‚úÖ File downloaded successfully</p>`;
                if (result.receiver_name) {
                    statusHtml += `<p><strong>Downloaded by:</strong> ${result.receiver_name}</p>`;
                }
                statusHtml += `<p><strong>Download time:</strong> ${new Date(result.access_time).toLocaleString()}</p>`;
                statusHtml += `<p style="color: #22543d; font-weight: bold;">üîí All data has been securely deleted</p>`;
                // Stop checking after download
                if (window.statusInterval) clearInterval(window.statusInterval);
                break;
                
            default:
                statusHtml += `‚ùì ${result.status}</p>`;
        }
        
        statusInfo.innerHTML = statusHtml;
        
    } catch (error) {
        console.error('Status check error:', error);
        document.getElementById('statusInfo').innerHTML = `
            <p><strong>Status:</strong> ‚ùå Unable to check status</p>
        `;
    }
}

function sendAnother() {
    // Clear status checking
    if (window.statusInterval) clearInterval(window.statusInterval);
    window.currentTransactionId = null;
    
    // Reset form
    document.getElementById('uploadForm').reset();
    document.getElementById('results').style.display = 'none';
    document.getElementById('statusSection').style.display = 'none';
    document.getElementById('compressionStats').style.display = 'none';
    document.querySelector('form').style.display = 'block';
    clearAlerts();
    
    // Remove file info
    const fileInfo = document.querySelector('.file-info');
    if (fileInfo) fileInfo.remove();
    
    // Clear intended receiver name field
    document.getElementById('intendedReceiverName').value = '';
}

// Missing utility functions - ADD THESE
function clearAlerts() {
    console.log('Clearing alerts');
    const existingAlerts = document.querySelectorAll('.alert:not(.alert-success):not(.alert-info):not(.alert-warning)');
    existingAlerts.forEach(alert => alert.remove());
}

function showAlert(message, type = 'error') {
    console.log('Showing alert:', message, type);
    clearAlerts();
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.style.margin = '15px 0';
    alertDiv.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i> ${message}`;
    
    // Insert alert at the top of the form
    const form = document.querySelector('form');
    form.parentNode.insertBefore(alertDiv, form);
    
    // Auto-remove error alerts after 5 seconds
    if (type === 'error') {
        setTimeout(() => alertDiv.remove(), 5000);
    }
}

function formatFileSize(bytes) {
    console.log('Formatting file size:', bytes);
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Functions from base.html that need to be available
function updateCryptoIndicator(selector, status) {
    console.log('Updating crypto indicator:', selector, status);
    const indicator = document.querySelector(selector);
    if (indicator) {
        indicator.classList.remove('processing', 'active');
        if (status === 'processing') {
            indicator.classList.add('processing');
        } else if (status === 'completed') {
            indicator.classList.add('active');
        }
    }
}

function updateProgress(percentage, title = 'Processing...') {
    console.log('Updating progress:', percentage, title);
    const container = document.querySelector('.progress-container');
    const fill = document.querySelector('.progress-fill');
    const titleEl = document.querySelector('.progress-title');
    const percentEl = document.querySelector('.progress-percentage');
    
    if (container && fill) {
        container.classList.add('show');
        fill.style.width = percentage + '%';
        if (titleEl) titleEl.textContent = title;
        if (percentEl) percentEl.textContent = percentage + '%';
        
        if (percentage >= 100) {
            setTimeout(() => {
                container.classList.remove('show');
            }, 1500);
        }
    }
}

function updateStepIndicator(activeStep) {
    console.log('Updating step indicator:', activeStep);
    const steps = document.querySelectorAll('.step');
    steps.forEach((step, index) => {
        step.classList.remove('active', 'completed');
        if (index < activeStep) {
            step.classList.add('completed');
        } else if (index === activeStep) {
            step.classList.add('active');
        }
    });
}
</script>
{% endblock %}